<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TEST 12 • Submit</title>
    <meta name="theme-color" content="#03060d" />
    <style>
      :root {
        --bg: #03060d;
        --border: #1f2937;
        --text: #e8eaff;
        --dim: #8b94a1;
        --accent: #6ce4ba;
        --highlight: #fedb7e;
      }
      * {
        box-sizing: border-box;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        background: radial-gradient(circle at 20% 20%, #0f2945, #050b16 55%, #000);
        color: var(--text);
      }
      .wrap {
        max-width: 720px;
        margin: 0 auto;
        padding: 48px 16px;
        min-height: 100%;
        display: grid;
        place-items: center;
      }
      .card {
        background: linear-gradient(145deg, rgba(14, 36, 63, 0.6), rgba(9, 29, 55, 0.7));
        border: 1px solid #1e3a5f;
        border-radius: 16px;
        padding: 18px 18px;
        box-shadow: 0 0 24px rgba(0, 150, 255, 0.14);
        width: 100%;
      }
      .title {
        margin: 0 0 10px 0;
        font-size: 18px;
        letter-spacing: 0.4px;
        font-weight: 900;
      }
      .muted {
        margin: 0 0 14px 0;
        color: var(--dim);
        font-size: 12px;
        line-height: 1.5;
      }
      .stack {
        display: grid;
        gap: 12px;
      }
      .label {
        display: block;
        font-size: 12px;
        letter-spacing: 0.2px;
        color: rgba(232, 234, 255, 0.92);
        margin-bottom: 8px;
      }
      .field {
        width: 100%;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid rgba(31, 41, 55, 0.9);
        background: rgba(3, 6, 13, 0.35);
        color: var(--text);
        outline: none;
      }
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: rgba(15, 20, 31, 0.9);
        color: var(--text);
        text-decoration: none;
        width: 100%;
        font-weight: 900;
        letter-spacing: 0.4px;
        cursor: pointer;
      }
      .btn[disabled] {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .pill {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid rgba(31, 41, 55, 0.9);
        background: rgba(3, 6, 13, 0.35);
        color: rgba(232, 234, 255, 0.94);
        font-size: 11px;
      }
      .ok {
        color: var(--accent);
      }
      .bad {
        color: #ff7b7b;
      }
      a {
        color: var(--highlight);
      }
    </style>
  </head>
  <body>
    <main class="wrap">
      <div class="card">
        <h1 class="title">Submit to queue</h1>
        <p class="muted">
          This posts to the shared queue backend.
          Backend: <span class="pill" id="apiBase">loading…</span>
        </p>

        <form id="f" class="stack" autocomplete="on">
          <div>
            <label class="label" for="userId">User ID (any text)</label>
            <input id="userId" class="field" type="text" required />
          </div>
          <div>
            <label class="label" for="appName">App name</label>
            <input id="appName" class="field" type="text" required />
          </div>
          <div>
            <label class="label" for="storeLink">Store link</label>
            <input id="storeLink" class="field" type="url" inputmode="url" required />
          </div>
          <button id="submitBtn" class="btn" type="submit">SUBMIT</button>
          <div class="muted" id="msg"></div>
          <div class="muted"><a href="/">Back</a> • <a href="/privacy">Privacy</a></div>
        </form>
      </div>
    </main>

    <script>
      const apiBaseEl = document.getElementById("apiBase");
      const msg = document.getElementById("msg");
      const f = document.getElementById("f");
      const submitBtn = document.getElementById("submitBtn");

      async function loadConfig() {
        try {
          const r = await fetch("/config.json", { cache: "no-store" });
          const j = await r.json();
          const base = String(j.api_base_url || "").trim();
          return base;
        } catch {
          return "";
        }
      }

      function setMsg(text, ok) {
        msg.textContent = text;
        msg.className = ok ? "muted ok" : "muted bad";
      }

      (async function init() {
        const base = await loadConfig();
        apiBaseEl.textContent = base || "(not set)";
        if (!base) {
          setMsg("Backend not set yet. Open /config.json and put your permanent backend URL in api_base_url.", false);
          submitBtn.disabled = true;
        }
      })();

      f.addEventListener("submit", async (e) => {
        e.preventDefault();
        submitBtn.disabled = true;
        setMsg("Submitting…", true);

        const base = await loadConfig();
        apiBaseEl.textContent = base || "(not set)";
        if (!base) {
          setMsg("Missing api_base_url in config.json.", false);
          submitBtn.disabled = false;
          return;
        }

        const userId = String(document.getElementById("userId").value || "").trim();
        const appName = String(document.getElementById("appName").value || "").trim();
        const storeLink = String(document.getElementById("storeLink").value || "").trim();

        try {
          const r = await fetch(`${base.replace(/\\/$/, "")}/api/submit`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user_id: userId, app_name: appName, store_link: storeLink })
          });
          const j = await r.json().catch(() => ({}));
          if (!r.ok || !j.ok) {
            setMsg("Submit failed. Check your backend URL and inputs.", false);
            submitBtn.disabled = false;
            return;
          }
          const pos = j.my_queue_position == null ? "—" : String(j.my_queue_position);
          const sess = j.session && j.session.status === "active" ? "ACTIVE" : "none";
          setMsg(`Submitted. Queue position: ${pos}. Session: ${sess}.`, true);
        } catch {
          setMsg("Network error. Is the backend running?", false);
        } finally {
          submitBtn.disabled = false;
        }
      });
    </script>
  </body>
</html>
